<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Hebrew:wght@100..900&display=swap" rel="stylesheet">
    <title>Tosefta with Variants</title>
    <style>
        body {
            font-family: 'Noto Serif Hebrew', serif;
            direction: rtl;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        #app {
            max-width: 1200px;
            margin: 0 auto;
        }
        #content-container {
            display: flex;
            flex-direction: column;
        }
        .paragraph-pair {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .text-content, .variant-content {
            width: 48%;
        }
        .chapter-header {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        .paragraph-number {
            position: absolute;
            right: -30px;
            top: 0;
            font-weight: bold;
            color: #888;
        }
        .paragraph-pair {
            position: relative;
            padding-right: 30px;
            margin-bottom: 10px;
        }

        sup {
            color: red;
        }
    </style>
</head>
<body>
    <div id="toggles">
        <label for="abbreviations">קיצורים</label>
        <input type="checkbox" id="abbreviations" name="abbreviations" value="abbreviations">
        <label for="mn">חלופי ם/ן</label>
        <input type="checkbox" id="mn" name="mn" value="mn">
        <label for="vavHibbur">ו׳ החיבור</label>
        <input type="checkbox" id="vavHibbur" name="vavHibbur" value="vavHibbur">
        <label for="maleh">מלא/חסר (ראשוני, וגס מאוד)</label>
        <input type="checkbox" id="maleh" name="maleh" value="maleh">
        &nbsp&nbsp&nbsp&nbsp|
        <a href="otzarHaHilufim.html">אוצר החילופים (עדיין בפיתוח)</a>
        &nbsp&nbsp&nbsp&nbsp|
        הוסתרו <span id="hidden_count">0</span> חילופים מתוך <span id="total_count">0</span>
    </div>
    <div id="masechet-selector">
        <label for="masechet-dropdown">Select Masechet:</label>
        <select id="masechet-dropdown"></select>
        <button id="load-masechet">Load Masechet</button>

        <!--    Link to OtzarHaHilufim-->
    </div>
    <div id="app">
            <div id="content-container"></div>
    </div>

    <script src="tosefta_parsing_tools.js"></script>
    <script>

        // Populate the dropdown
        const dropdown = document.getElementById('masechet-dropdown');
        locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location;
            option.textContent = location.split('/')[1].replace('Tosefta%20', '').replace('%20', ' ');
            dropdown.appendChild(option);
        });

        // Function to load the selected masechet
        function loadSelectedMasechet() {
            const selectedLocation = dropdown.value.replace(' ', "%20");
            const textUrl = url1 + selectedLocation + url2;
            const variantsUrl = variant_url1 + selectedLocation.replace("Tosefta%20", "Variants%20on%20") + variants_url2;

            Promise.all([
                getToseftaText(selectedLocation),
                getToseftavariants(selectedLocation)
            ])
            .then(([textData, variantsData]) => {
                displayTextAndVariants(textData, variantsData);
            })
            .catch(error => {
                console.error('Error loading the JSON files:', error);
                document.getElementById('app').textContent = 'Error loading data';
            });
        }

        // Add event listener to the load button
        document.getElementById('load-masechet').addEventListener('click', loadSelectedMasechet);


        function simple_displayTextAndVariants(textData, variantsData) {
            const contentContainer = document.getElementById('content-container');

            const textArray = textData.text[0];
            const variantsArray = variantsData.text[0];

            textArray.forEach((textItem, index) => {
                const paragraphPair = document.createElement('div');
                paragraphPair.className = 'paragraph-pair';

                // Display main text
                const textParagraph = document.createElement('p');
                textParagraph.className = 'text-content';
                const updatedText = textItem.replace(/<i data-commentator="Variants" data-label="([^"]+)" data-order="\d+"><\/i>/g, '<sup>$1</sup>');
                textParagraph.innerHTML = updatedText;

                // Display corresponding variant
                const variantParagraph = document.createElement('p');
                variantParagraph.className = 'variant-content';
                variantsArray[index].forEach(variantItem => {
                    variantParagraph.innerHTML += variantItem + ' ';
                });

                paragraphPair.appendChild(textParagraph);
                paragraphPair.appendChild(variantParagraph);
                contentContainer.appendChild(paragraphPair);
            });
        }


function displayTextAndVariants(textData, variantsData) {
    const contentContainer = document.getElementById('content-container');
    const abbreviationsCheckbox = document.getElementById('abbreviations');
    const mnCheckbox = document.getElementById('mn');
    const vavHibburCheckbox = document.getElementById('vavHibbur');
    const malehCheckbox = document.getElementById('maleh');


    function updateDisplay() {
            hidden_count = 0;
            total_count = 0;
        contentContainer.innerHTML = ''; // Clear existing content

        const textArray = textData.text; // Note the [0] here
        const variantsArray = variantsData.text; // And here

        textArray.forEach((textPerek, perekIndex) => {
            // Add chapter header
            const chapterHeader = document.createElement('h2');
            chapterHeader.className = 'chapter-header';
            chapterHeader.textContent = `פרק ${perekIndex + 1}`;
            contentContainer.appendChild(chapterHeader);

            textPerek.forEach((textItem, halachaIndex) => {
                const paragraphPair = document.createElement('div');
                paragraphPair.className = 'paragraph-pair';

                // Add paragraph (halacha) number
                const paragraphNumber = document.createElement('span');
                paragraphNumber.className = 'paragraph-number';
                paragraphNumber.textContent = halachaIndex + 1;
                paragraphPair.appendChild(paragraphNumber);

                // Display main text
                const textParagraph = document.createElement('p');
                textParagraph.className = 'text-content';
                const updatedText = textItem.replace(/<i data-commentator="Variants" data-label="([^"]+)" data-order="\d+"><\/i>/g, '<sup>$1</sup>');
                textParagraph.innerHTML = updatedText;

                // Display corresponding variant
                const variantParagraph = document.createElement('p');
                variantParagraph.className = 'variant-content';

                if (variantsArray[perekIndex] && variantsArray[perekIndex][halachaIndex]) {
                    variantsArray[perekIndex][halachaIndex].forEach(variantItem => {
                        const parsedNote = parseNote3(variantItem);
                        if (parsedNote) {
                            const [sv, vars] = parsedNote;
                            var first = true;
                            vars.forEach(([witnesses, varText]) => {
                                if (!abbreviationsCheckbox.checked || !isKitzur(sv, varText)){
                                 if (!mnCheckbox.checked || !isMN(sv, varText)){
                                    if (!vavHibburCheckbox.checked || !isVavHaChiburDiff(sv, varText)){
                                     if (!malehCheckbox.checked || !prelimHaserCheck(sv, varText)) {
                                        if (first) {
                                            variantParagraph.innerHTML += `<b>${sv}|</b>&nbsp;`;
                                            first = false;
                                        }
                                        variantParagraph.innerHTML += `<span class="variant">${witnesses}</span>&nbsp;${varText} `;
                                        total_count++;
                                     }else{
                                        console.log("Haser", sv, varText);
                                        hidden_count++;
                                     }
                                    }else{
                                        console.log("Vav", sv, varText);
                                        hidden_count++;
                                    }
                                 }else{
                                    console.log("MN", sv, varText);
                                    hidden_count++;
                                 }
                                }else{
                                    console.log("Kitzur", sv, varText);
                                    hidden_count++;
                                }
                            });
                            variantParagraph.innerHTML += '. <spacer>';
                        }
                    });
                }

                paragraphPair.appendChild(textParagraph);
                paragraphPair.appendChild(variantParagraph);
                contentContainer.appendChild(paragraphPair);
            });
        });
        document.getElementById('hidden_count').textContent = hidden_count;
        document.getElementById('total_count').textContent = hidden_count + total_count;
    }

    // Initial display
    updateDisplay();

    // Add event listeners to checkboxes
    abbreviationsCheckbox.addEventListener('change', updateDisplay);
    mnCheckbox.addEventListener('change', updateDisplay);
    vavHibburCheckbox.addEventListener('change', updateDisplay);
    malehCheckbox.addEventListener('change', updateDisplay);
}
// Fetch both JSON files
//         Promise.all([
//             fetch('Tosefta_Megillah.json').then(response => response.json()),
//             fetch('Variants_Megillah.json').then(response => response.json())
//         ])
//         .then(([textData, variantsData]) => {
//             displayTextAndVariants(textData, variantsData);
//         })
//         .catch(error => {
//             console.error('Error loading the JSON files:', error);
//             document.getElementById('app').textContent = 'Error loading data';
//         });

    </script>
</body>
</html>